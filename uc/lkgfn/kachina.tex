\begin{leakagefn}{$\lkgfnmainkachina(\tnsfnkachina, \vn{desc}, \vn{dep})$}
  The \kachina\ leakage function reveals the public state transcript generated by
  $\tnsfnkachina$ during the projected transition. This projected transition takes
  the state of the contract as the party currently sees it, and first replays
  all currently unconfirmed transactions from the same party. Both the initial
  (latest confirmed) contract state, as well as the projected state, and a
  randomness stream are considered the transaction's context.

  \vsep

  \begin{receiveinput*}{$(\partyview = (\ell, U, T, \jointstate = (\sigma^o, \boldsymbol\rho^o)), \party, w)$}
    \State \Let $(\sigma^\pi, \rho^\pi) \gets (\sigma^o, \boldsymbol\rho^o[\party])$
    \For{$u \loopin U$}
      \State \Let $(\party', w', (\transcript_\sigma, z), \cdot, \cdot, D) \gets T(u)$
      \If{$\transcript_\sigma(\sigma^\pi) = \bot$}
        \State \Return $(\bot, \bot, \bot, \bot, \bot)$
      \EndIf
      \State \Let $(\partstate{\sigma}, \cdot, \partstate{\rho}, \transcript, \cdot) \gets
        \runtnsfn(\sigma^\pi, \rho^\pi, w', z, \party' \in \honest)$
      \State \Let $\sigma^\pi \gets \vn{last}(\partstate{\sigma}); \rho^\pi
        \gets \vn{last}(\partstate{\rho})$
      \State \Let $X \gets X \concat (u, \transcript, z, D)$
    \EndFor
    \State \Let $\eta$ be a randomness stream.
    \State \Let $z \gets (\sigma^o, \boldsymbol\rho^o[\party], \sigma^\pi,
      \rho^\pi, \eta)$
    \State \Let $(\partstate{\sigma}, \transcript_\sigma, \partstate{\rho}, \transcript_\rho, \cdot)
      \gets \runtnsfn(\sigma^\pi, \rho^\pi, w, z, \top)$
    \If{$\vn{last}(\partstate{\sigma}) = \bot \lor \vn{last}(\partstate{\rho}) = \bot$}
      \State \Return $(\bot, \bot, \bot, \bot, \bot)$
    \Else
      \State \Let $D \gets \vn{dep}(X, \transcript_\rho, z)$
      \State \Return $(\vn{desc}(t, X, \transcript_\sigma, \transcript_\rho,
        w, z), \transcript_\sigma, D, (\transcript_\sigma, z))$
    \EndIf
  \end{receiveinput*}
\end{leakagefn}
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../../main"
%%% End:
